 Ext.ns('Bats');var shareFmt=Ext.util.Format.numberRenderer('0,000');var priceFmt2=Ext.util.Format.numberRenderer('0.00');var priceFmt3=Ext.util.Format.numberRenderer('0.000');var priceFmt4=Ext.util.Format.numberRenderer('0.0000');var priceFmt5=Ext.util.Format.numberRenderer('0.00000');Ext.define('Bats.Book',{boldOptimalSpread:true,count:'',ctype:"Bats.Book",deferID:0,failureCnt:0,id:'bookViewer',isOptions:false,loadOnInit:true,marketToggleType:'menu',maxPrecision:4,minPrecision:2,minPrecisionFmt:priceFmt2,maxPrecisionFmt:priceFmt4,symbol:'',ttl:0,useOldURL:false,visibleMkt:'',maskMessage:'Loading...',marketToggleConfig:{toggleElementCls:'market-toggle-menu',menuItemCls:'menuitem',menuItemSelectedCls:'selected'},companyRegex:/(- Common Stock|- Warrants|- Class A Common Stock)/ig,showLinkToAuctionViewer:true,cellClasses:['book-viewer__ask-shares','book-viewer__ask-price','book-viewer__bid-shares','book-viewer__bid-price','book-viewer__trades-time','book-viewer__trades-price','book-viewer__trades-shares','book-viewer__trades-quotes','book-viewer__ask__th','book-viewer__bid__th','book-viewer__ask-shares-head','book-viewer__ask-price-head','book-viewer__trades-time-head','book-viewer__trades-price-head','book-viewer__trades-shares-head','book-viewer__trades-quotes-head','book-viewer-orders','book-viewer-volume','book-viewer-orders-head','book-viewer-volume-head','book-viewer-top-of-book','book-viewer-last-trades'],constructor:function(config){config=config||{};config.ttl=typeof(config.ttl)!='undefined'?config.ttl:5500;Ext.apply(this,config);this.init();},init:function(){this.isOptionsRegion();this.id='bookViewer'+this.count;this.bookViewerElement=Ext.get(this.id);if(this.getSupportedMarkets){this.supportedMarkets=this.getSupportedMarkets();} var marketToggle=new bats.MarketToggle({config:this.marketToggleConfig,id:this.id,toggleType:this.marketToggleType,listeners:{marketToggleEvent:this.marketToggleEvent,scope:this}});this.mkts=this.mkts?this.mkts:{};var mktFound=false;for(var i=0,l=this.supportedMarkets.length;i<l;i++){var mktName=this.supportedMarkets[i];this.mkts[mktName]={'data':{},'visible':false,'stale':true,'reloadCount':3};if(mktName==this.visibleMkt){mktFound=true;}} if(!mktFound){this.visibleMkt=this.supportedMarkets[0];} this.mkts[this.visibleMkt].visible=true;if(this.loadOnInit){this.load(this.symbol);}else{if(this.ttl>0){this.deferID=Ext.defer(this.load,this.ttl,this,[this.symbol]);}}},addLoadingMask:function(extElement){var version=Ext.getVersion();if(version.getMajor()>=5){extElement.mask(this.message);}else{this.msk=new Ext.LoadMask(extElement,{msg:this.maskMessage});this.msk.show();}},hideLoadingMask:function(extElement){var version=Ext.getVersion();if(version.getMajor()>=5){extElement.unmask();}else{if(Ext.isDefined(this.msk)){this.msk.hide();}}},isOptionsRegion:function(){if(['opt','exo','ctwo','cone'].indexOf(this.region)!==-1){this.isOptions=true;}else{this.isOptions=false;}},marketToggleEvent:function(mktName){this.show(mktName);},setStale:function(mktName){this.mkts[mktName].stale=true;},defaultView:function(){this.cellClasses.forEach(function(columnClassName){rows=document.getElementsByClassName(columnClassName);for(var i=0;i<rows.length;i++){rows[i].style.display='table-cell';}});document.getElementsByClassName('book-viewer__symbol-fullname')[0].colSpan=1;var quotesCol=document.getElementsByClassName('book-viewer__ask book-viewer__ask-quotes');for(var i=0;i<quotesCol.length;i++){quotesCol[i].style.display='none';} var quotesCol=document.getElementsByClassName('book-viewer__bid book-viewer__bid-quotes');for(var i=0;i<quotesCol.length;i++){quotesCol[i].style.display='none';} if(['cxe','bxe','trf','sis'].indexOf(this.visibleMkt)>-1){document.getElementsByClassName('book-viewer-orders-head')[0].innerText='Orders Accepted';document.getElementsByClassName('book-viewer__ask-price-head')[0].colSpan=1;document.getElementsByClassName('book-viewer__trades-time-head')[0].innerHTML='Time';document.getElementsByClassName('book-viewer__ask-shares-head')[0].innerHTML='Shares';document.getElementsByClassName('book-viewer__ask-price-head')[0].innerHTML='Price';document.getElementsByClassName('book-viewer-expander-all')[0].style.display='none';}},sisView:function(){['book-viewer__trades-time','book-viewer__trades-price','book-viewer__trades-shares','book-viewer__trades-price-head','book-viewer__trades-shares-head','book-viewer-orders','book-viewer-volume','book-viewer-orders-head','book-viewer-volume-head','book-viewer-last-trades'].forEach(function(columnClassName){rows=document.getElementsByClassName(columnClassName);for(var i=0;i<rows.length;i++){rows[i].style.display='none';}});var extraBits=['book-viewer__ask-quotes','book-viewer__bid-quotes','book-viewer-expander-all'];extraBits.forEach(function(columnClassName){rows=document.getElementsByClassName(columnClassName);for(var i=0;i<rows.length;i++){rows[i].style.display='table-cell';}});document.getElementsByClassName('book-viewer__trades-time-head')[0].innerHTML='Quoters';document.getElementsByClassName('book-viewer__ask-shares-head')[0].innerHTML='Price';document.getElementsByClassName('book-viewer__ask-price-head')[0].innerHTML='Share Count';document.getElementsByClassName('book-viewer__symbol-fullname')[0].colSpan=3;if(this.tradingFirmId!=null){var askPrice=document.getElementsByClassName('book-viewer__ask-price');var bidPrice=document.getElementsByClassName('book-viewer__bid-price');for(var i=0;i<5;i++){askPrice[i].style.display='none';bidPrice[i].style.display='none';} document.getElementsByClassName('book-viewer__ask-price-head')[0].colSpan=1;}},trfView:function(){['book-viewer-top-of-book','book-viewer__ask-shares-head','book-viewer__ask-price-head','book-viewer__ask__th','book-viewer__ask-shares','book-viewer__ask-price','book-viewer__bid__th','book-viewer__bid-shares','book-viewer__bid-price','book-viewer-price'].forEach(function(columnClassName){rows=document.getElementsByClassName(columnClassName);for(var i=0;i<rows.length;i++){rows[i].style.display='none';}});document.getElementsByClassName('book-viewer-orders-head')[0].innerText='Trades Accepted';},show:function(mktName){this.visibleMkt=mktName;var mkt=this.mkts[mktName];mkt.visible=true;mkt.reloadCount=3;this.defaultView();if(mktName==='sis'){this.sisView();}else if(mktName==='trf'){this.trfView();} if((mkt.stale)||(mkt.data.symbol!=this.symbol)){this.addLoadingMask(Ext.fly(this.id));this.load(this.symbol);}else{this.updateNameAndVolumeData(mkt.data);this.updateRowData(mkt.data);this.hideLoadingMask(Ext.fly(this.id));} for(var key in this.mkts){if(key!=mktName){this.mkts[key].visible=false;Ext.defer(this.setStale,this.ttl,this,[key]);}}},isMktStale:function(m){if(!this.mkts[m].visible&&this.mkts[m].reloadCount<1){return true;} return false;},buildURL:function(mkt,sym){sym=encodeURIComponent(sym);if(mkt==='sis'){return String.format('/{1}/book/{0}/data/',sym,mkt);} if(mkt==='agg'){return String.format('{0}/{1}/data',mkt,sym);}else if(!this.useOldURL){return String.format('/json/{0}/book/{1}',mkt,sym);}else{return String.format('/{1}/book/{0}/data/',sym,mkt);}},load:function(s){clearTimeout(this.deferID);if(!s){return;} this.symbol=s;if(window.opener&&s!==this.symbol){document.title=s+' - Bats '+batsWord+' Book Viewer';window.location='/'+this.visibleMkt+'/book/'+escape(s)+'/';} if(!this.isOption){var div=document.getElementById('bookViewerForm2'+this.count);if(div&&typeof x!=='undefined'){div.className="bookViewerForm2 loading";}} if(this.currentRequest&&Ext.Ajax.isLoading(this.currentRequest)){Ext.Ajax.abort(this.currentRequest);} this.currentRequest=Ext.Ajax.request({url:this.buildURL(this.visibleMkt,s),disableCaching:false,success:this.loadSuccess,failure:this.loadFailed,scope:this});},loadSuccess:function(data,params){this.hideLoadingMask(Ext.fly(this.id));var mkt=this.mkts[this.visibleMkt];mkt.stale=false;if(!this.isOption){var div=document.getElementById('bookViewerForm2'+this.count);if(div&&typeof div!=='undefined'){div.className="bookViewerForm2";}} res=Ext.decode(data.responseText);bats.execAjaxScript(res);if(res.success){this.ttl=bats.getTTL(res.reload);var key=this.visibleMkt;if(res.data[key]){var data=res.data[key];}else{var data=res.data;} if(data){mkt.data=data;this.symbol=data.symbol;this.updateNameAndVolumeData(data);this.updateRowData(data);} if(this.ttl>0){this.deferID=Ext.defer(this.load,this.ttl,this,[this.symbol]);} this.updateMarketQualityLink();}else{Ext.get('bkCompany'+this.count).dom.innerHTML=res.statusText;Ext.get('bkOrdersAccepted'+this.count).dom.innerHTML='&nbsp;';Ext.get('bkTotalShares'+this.count).dom.innerHTML='&nbsp;';this.updateRowData({asks:[],bids:[],trades:[]});this.updateMarketQualityLink(true);}},loadFailed:function(response,opts){if(!this.isOption){var div=document.getElementById('bookViewerForm2'+this.count);if(div&&typeof div!=='undefined'){div.className="bookViewerForm2";}} this.failureCnt++;if(this.failureCnt==4){return;} this.ttl=this.ttl*2;this.deferID=Ext.defer(this.load,this.ttl,this,[this.symbol]);},updateNameAndVolumeData:function(data){var idx=this.count,companyEl=Ext.get('bkCompany'+idx);Ext.get('bkTimestamp'+idx).update(data.timestamp);if(this.isOption&&!Ext.isEmpty(companyEl)){companyEl.update(Ext.util.Format.htmlEncode(data.hrname));}else{if(data.auction&&this.showLinkToAuctionViewer){var company=[Ext.util.Format.htmlEncode(this.companyNameFilter(data.company)),'<div style="font-size:85%;">','<a target="_blank" href="/market_data/auction/">Auction in progress</a>','</div>'].join('');}else{var company=Ext.util.Format.htmlEncode(this.companyNameFilter(data.company));} if(!Ext.isEmpty(companyEl)){companyEl.update(company);}} if(!Ext.isEmpty(Ext.fly('bkOrdersAccepted'+idx))){var totalOrders=data.ordersOrTrades?data.ordersOrTrades:data.orders;Ext.get('bkOrdersAccepted'+idx).update(shareFmt(totalOrders));} if(!Ext.isEmpty(Ext.fly('bkTotalShares'+idx))){if(!Ext.isEmpty(this.totalPrefix)){Ext.get('bkTotalShares'+idx).update(this.totalPrefix+shareFmt(data.volume));}else{Ext.get('bkTotalShares'+idx).update(shareFmt(data.volume));}}},updateRowData:function(data){var divData=document.getElementById('bkData'+this.count);if(data.asks.length===0&&data.bids.length===0&&data.trades.length===0){divData.style.opacity=0.4;divData.style.zoom=1;}else{divData.style.opacity=1.0;divData.style.zoom=1;} var optimalSpread=false;if((data.asks.length>0)&&(data.bids.length>0)){if(Math.round((data.asks[0][1]/1-data.bids[0][1])*100)==1){optimalSpread=true;}} var price;var item;var cells;var priceFmt=this.whichPriceFmt(data);var rows=document.getElementById('asks'+this.count).getElementsByTagName('tbody')[0].rows;var items=data.asks;var len=items.length;var idx=5;for(var ri=0;ri<5;ri++){idx--;cells=rows[ri].cells;item=items[idx];if(idx<len){cells[0].innerHTML=shareFmt(item[0]);price=priceFmt(item[1]);if(this.boldOptimalSpread&&(ri==4)&&optimalSpread){cells[1].innerHTML='<b>'+price+'</b>';}else{cells[1].innerHTML=price;}}else{cells[0].innerHTML='&nbsp;';cells[1].innerHTML='&nbsp;';}} rows=document.getElementById('bids'+this.count).getElementsByTagName('tbody')[0].rows;items=data.bids;len=items.length;for(var ri=0;ri<5;ri++){cells=rows[ri].cells;item=items[ri];if(ri<len){cells[0].innerHTML=shareFmt(item[0]);price=priceFmt(item[1]);if(this.boldOptimalSpread&&(ri===0)&&optimalSpread){cells[1].innerHTML='<b>'+price+'</b>';}else{cells[1].innerHTML=price;}}else{cells[0].innerHTML='&nbsp;';cells[1].innerHTML='&nbsp;';}} rows=document.getElementById('trades'+this.count).getElementsByTagName('tbody')[0].rows;items=data.trades;for(var ri=0;ri<10;ri++){cells=rows[ri].cells;item=items[ri];if(item){cells[0].innerHTML=item[0];cells[1].innerHTML=priceFmt(item[2]);cells[2].innerHTML=shareFmt(item[1]);}else{cells[0].innerHTML='&nbsp;';cells[1].innerHTML='&nbsp;';cells[2].innerHTML='&nbsp;';}}},updateMarketQualityLink:function(useBaseLink){useBaseLink=(Ext.isDefined(useBaseLink)&&useBaseLink)?true:false;var el=Ext.get(this.id+'-mqs-link');if(!Ext.isEmpty(el)){if(useBaseLink){el.set({'href':'/market_data/quality/'+this.symbol});}else{el.set({'href':'/market_data/execution_quality/symbol/'+this.symbol});}}},whichPriceFmt:function(data){var tick_type=data.tick_type||'';if(tick_type!=''){return this.tickMap[tick_type];} var items=data.asks;if(this.requiredPrecision(items,1)==this.maxPrecision){return this.maxPrecisionFmt;} var items=data.bids;if(this.requiredPrecision(items,1)==this.maxPrecision){return this.maxPrecisionFmt;} var items=data.trades;if(this.requiredPrecision(items,2)==this.maxPrecision){return this.maxPrecisionFmt;} return this.minPrecisionFmt;},requiredPrecision:function(items,priceIdx){var price;for(var idx=0,len=items.length;idx<len;idx++){price=items[idx][priceIdx];if((Math.round(price*100)/100)!=price){return this.maxPrecision;}} return this.minPrecision;},companyNameFilter:function(val){return Ext.String.trim(val.replace(this.companyRegex,''));},refresh:function(s){this.load(s);},allcaps:function(v){v=Ext.String.trim(v);if(v.length==0){v=this.symbol;} return v.toUpperCase();},asis:function(v){return v;},removenonalpha:function(v){v=v.replace(/[^A-Z]*/g,'');return allcaps(v);},postlowercap:function(v){v=v.trim();if(v.length==0){v=this.symbol;} return v.substring(0,v.length-1).toUpperCase()+ v.substring(v.length-1).toLowerCase();},spawn:function(){var s=this.symbol;if(s!==""){s+="/";} bats.openWin({src:'/'+this.visibleMkt+'/book/'+s,width:375,height:425});}});
 bats.expandedRows=[];var ASK_ROWS_COUNT=5;var BID_ROWS_COUNT=5;function toggleRow(el,action,rowId){var newClass='sprite--expand',displayValue='none';if(action==='expand'){newClass='sprite--collapse';displayValue='block';} if(action==='expand'){if(!bats.expandedRows.contains(rowId)){bats.expandedRows.push(rowId);}}else{bats.expandedRows.splice(bats.expandedRows.indexOf(rowId),1);} if(el===undefined){return;} var extEl=Ext.get(el);extEl.removeCls('sprite--expand');extEl.removeCls('sprite--collapse');extEl.addCls(newClass);var extras=document.getElementsByClassName(rowId);for(var i=0;i<extras.length;i++){extras[i].style.display=displayValue;}} Ext.define('Bats.BatsComBook',{override:'Bats.Book',isOptimalSpread:false,showLinkToAuctionViewer:false,tradingFirmId:null,tradingFirmFilterBox:null,tradingFirmListDefaults:[{value:'all',display:'Show all',qtip:''}],init:function(config){this.callParent(arguments);this.updateDescription(this.visibleMkt);this.addEvents();var that=this;Ext.tip.QuickTipManager.init();if(['cxe','bxe','trf','sis'].indexOf(this.visibleMkt)>-1){this.tradingFirmFilterBox=Ext.create('Ext.form.field.ComboBox',{displayField:'display',valueField:'value',width:220,queryMode:'local',editable:false,autoSelect:true,store:new Ext.data.SimpleStore({fields:['value','display','qtip'],data:this.tradingFirmListDefaults}),listeners:{buffer:50,change:function(){var store=this.store,val=this.getValue();store.clearFilter();that.tradingFirmId=null;if(val!=='all'){that.tradingFirmId=val;} if(that.visibleMkt==='sis'){that.show(that.visibleMkt);}}},listConfig:{tpl:['<ul class="trading-firm-filter"><tpl for=".">','<li role="option" class="x-boundlist-item" '+'data-qtip="{qtip}">{display}</li>','</tpl></ul>']}});this.tradingFirmFilterBox.render('trading-firm-filter');}},addEvents:function(){this.bookViewerElement.on({click:function(e,t){var path='';if(Ext.fly(t).hasCls(this.popoutCls)){path=Ext.String.format(this.popoutPath);this.spawn(path);}},scope:this});Ext.get(this.bookViewerElement.id).select('#extra-data-toggle').on({'click':function(evt,el){evt.preventDefault();var action=el.innerText==='Expand All'?'expand':'collapse';el.innerText=el.innerText==='Expand All'?'Collapse All':'Expand All';var rowTypes=['ask','bid'],i,j,rowId,toggleRowId;for(i=0;i<rowTypes.length;i++){for(j=0;j<5;j++){rowId=rowTypes[i]+'-'+j;toggleRowId='toggle-'+rowId;el=document.getElementsByClassName(toggleRowId)[0];toggleRow(el,action,rowId);}}}});},marketToggleEvent:function(mktName){this.updateDescription(mktName);this.show(mktName);},updateDescription:function(mktName){var el=Ext.get(this.id);if(!Ext.isEmpty(el)){el=el.select('.app__description');if(Ext.isDefined(el)){el.update(this.getDescription(mktName));}}},getDescription:function(mktName){var desc,trfExtra='on the BXTR trade reports ';desc=Ext.String.format('Shows the top bids and asks {0}for any symbol.',(mktName==='trf'?trfExtra:''));return desc;},toggleDataTableOpacity:function(makeTransparent){var dataTable=Ext.get(this.appId).select('.book-viewer-data-table');if(makeTransparent){dataTable.addCls('book-viewer-data-table--transparent');if(this.visibleMkt==='sis'){this.resetSingleTradingFirmView();}}else{dataTable.removeCls('book-viewer-data-table--transparent');}},updateMarketQualityLink:function(useBaseLink){},setOptimalSpread:function(data){this.isOptimalSpread=false;if((data.asks.length>0)&&(data.bids.length>0)){if(Math.round((data.asks[0][1]/1-data.bids[0][1])*100)===1){this.isOptimalSpread=true;}}},singleTradingFirmView:function(data){document.getElementsByClassName('book-viewer__trades-time-head')[0].style.display='none';if(!this.getAllTradingFirms(data).contains(this.tradingFirmId)){data.asks=[];data.bids=[];}else{data.tradingFirmId=this.tradingFirmId;var tradingFirmData=this.getTradingFirmAskAndBid(this.tradingFirmId,data);data.subAsks=[];data.subBids=[];data.subAsks_count=0;data.subBids_count=0;data.asks=tradingFirmData.ask?[tradingFirmData.ask]:[];data.bids=tradingFirmData.bid?[tradingFirmData.bid]:[];data.asks_count=tradingFirmData.ask?1:0;data.bids_count=tradingFirmData.bid?1:0;data.subAsks=[data.asks[0][1],[[this.tradingFirmId,data.asks[0][0]]]];data.subBids=[data.bids[0][1],[[this.tradingFirmId,data.bids[0][0]]]];var cells=document.getElementsByClassName('book-viewer-data-row');document.getElementsByClassName('book-viewer__ask__th')[0].style.display='none';document.getElementsByClassName('book-viewer__bid__th')[0].style.display='none';for(var i=0;i<ASK_ROWS_COUNT+BID_ROWS_COUNT;i++){if(i===ASK_ROWS_COUNT-1||i===BID_ROWS_COUNT){continue;} cells[i].style.display='none';} var bookAskShort=document.getElementById('book-viewer__ask-short__th');if(bookAskShort){bookAskShort.style.display='table-cell';} var bookBidShort=document.getElementById('book-viewer__bid-short__th');if(bookBidShort){bookBidShort.style.display='table-cell';} var priceCells=document.getElementsByClassName('book-viewer-price');for(i=0;i<priceCells.length;i++){priceCells[i].style.display='none';}}},resetSingleTradingFirmView:function(){var askShortTH=document.getElementById('book-viewer__ask-short__th'),bidShortTH=document.getElementById('book-viewer__bid-short__th');document.getElementsByClassName('book-viewer__trades-time-head')[0].style.display='table-cell';var cells,i;cells=document.getElementsByClassName('book-viewer-data-row');if(['bxe','cxe','sis'].indexOf(this.visibleMkt)>-1){document.getElementsByClassName('book-viewer__ask__th')[0].style.display='table-cell';document.getElementsByClassName('book-viewer__bid__th')[0].style.display='table-cell';} for(i=0;i<ASK_ROWS_COUNT+BID_ROWS_COUNT;i++){cells[i].style.display='';} if(askShortTH&&bidShortTH){document.getElementById('book-viewer__ask-short__th').style.display='none';document.getElementById('book-viewer__bid-short__th').style.display='none';} if(this.visibleMkt==='sis'){var priceCells=document.getElementsByClassName('book-viewer-price');for(i=0;i<priceCells.length;i++){priceCells[i].style.display='table-cell';}}},updateRowData:function(data){this.resetSingleTradingFirmView();var data=JSON.parse(JSON.stringify(data));if(this.visibleMkt==='sis'){var mics=[];this.getTradingFirmsList(data).forEach(function(v){mics.push({value:v[0],display:v[0],qtip:v[1]});});mics=this.tradingFirmListDefaults.concat(mics);this.tradingFirmFilterBox.store.loadData(mics);var selectedValue=this.tradingFirmFilterBox.getValue();if(mics.map(function(el){return el.value;}).indexOf(selectedValue)===-1){selectedValue='all';} this.tradingFirmFilterBox.select(selectedValue,true);this.resetSingleTradingFirmView();if(this.tradingFirmId!=null){this.singleTradingFirmView(data);}} this.priceFmt=this.whichPriceFmt(data);this.appId='bookViewer'+this.count;if(data.asks.length===0&&data.bids.length===0&&data.trades.length===0){this.tradingFirmId=null;this.toggleDataTableOpacity(true);}else{this.toggleDataTableOpacity(false);} this.updateCells('ask',data);this.updateCells('bid',data);this.setOptimalSpread(data);this.updateTradeCells(data.trades);},updateCells:function(type,orgData){var data,subs,boldRow;if(type==='ask'){data=orgData.asks;subs=orgData.subAsks;boldRow=4;}else{data=orgData.bids;subs=orgData.subBids;boldRow=0;} var sharesCells=Ext.get(this.appId).select('.book-viewer__'+type+'-shares').elements,priceCells=Ext.get(this.appId).select('.book-viewer__'+type+'-price').elements,quoteCells=Ext.get(this.appId).select('.book-viewer__'+type+'-quotes').elements,len=sharesCells.length,pointer=len,shareCell,priceCell,quoteCell,price,item,idx,expander;for(var i=0;i<len;i++){pointer--;shareCell=Ext.get(sharesCells[i]);priceCell=Ext.get(priceCells[i]);quoteCell=Ext.get(quoteCells[i]);if(type==='ask'){item=data[pointer];idx=pointer;}else{item=data[i];idx=i;} if(idx<data.length){shareCell.update(shareFmt(item[0]));var orgPrice=item[1];price=this.priceFmt(orgPrice);if(this.boldOptimalSpread&&(i===boldRow)&&this.isOptimalSpread){priceCell.update('<strong>'+price+'</strong>');}else{priceCell.update(price);} if(this.visibleMkt==='sis'){var expanderRowCls=type+'-'+i;var span=document.createElement('span');span.setAttribute('data-rowId',expanderRowCls);expander=new Ext.Element(span);expander.appId=this.appId;expander.addCls('expander sprite toggle-'+expanderRowCls);if(bats.expandedRows.indexOf(expanderRowCls)>-1){expander.addCls('sprite--collapse');}else{expander.addCls('sprite--expand');} price=new Ext.Element(document.createTextNode(price||'-'));shareCell.update('&nbsp;');if(this.tradingFirmId===null){shareCell.appendChild(expander.dom);expander.on({'click':function(evt,el){var action='collapse';if(el.classList.contains('sprite--expand')){action='expand';} toggleRow(el,action,el.getAttribute('data-rowid'));}});} this.updateSISCells('share-counts',quoteCell,orgPrice,subs,expanderRowCls);this.updateSISCells('trading-firms',priceCell,orgPrice,subs,expanderRowCls);shareCell.appendChild(price.dom);}}else{shareCell.update('&nbsp;');priceCell.update('&nbsp;');if(quoteCell!==null&&quoteCell.update){quoteCell.update('&nbsp;');}}}},updateSISCells:function(type,extEl,orgPrice,subs,expanderRowCls){extEl.update('');if(this.tradingFirmId){if(type==='share-counts'){extEl.update(subs[1][0][1]);} return;} var cells=subs.filter(function(el){return el[0]==orgPrice;})[0][1];var i=type==='trading-firms'?0:1;var values=cells.map(function(el){return[el[i],el[2]];});var total=0;if(type==='share-counts'){values.forEach(function(el){total+=el[0];});}else{total=cells.length;} var count=new Ext.Element(document.createTextNode(total));extEl.appendChild(count);var extra=document.createElement('div');extra.setAttribute('class','book-viewer__'+type+' '+expanderRowCls);if(bats.expandedRows.indexOf(expanderRowCls)>-1){extra.style.display='block';}else{extra.style.display='none';} var side=expanderRowCls.split('-')[0];values.forEach(function(el){var extrasDiv=document.createElement('div');extrasDiv.append(el[0]);if(type==='trading-firms'){extrasDiv.setAttribute('data-qtip',el[1]);} if(side==='ask'){extra.prepend(extrasDiv);}else{extra.append(extrasDiv);}});if(side==='ask'){extEl.insertFirst(extra);}else{extEl.appendChild(extra);}},updateTradeCells:function(data){var timeCells=Ext.get(this.appId).select('.book-viewer__trades-time').elements,sharesCells=Ext.get(this.appId).select('.book-viewer__trades-shares').elements,priceCells=Ext.get(this.appId).select('.book-viewer__trades-price').elements,len=sharesCells.length,shareCell,priceCell,timeCell,item;for(var i=0;i<len;i++){shareCell=Ext.get(sharesCells[i]);priceCell=Ext.get(priceCells[i]);timeCell=Ext.get(timeCells[i]);item=data[i];if(item){timeCell.update(item[0]);priceCell.update(this.priceFmt(item[2]));shareCell.update(shareFmt(item[1]));}else{timeCell.update('&nbsp;');priceCell.update('&nbsp;');shareCell.update('&nbsp;');}}},getAllTradingFirms:function(data){if(data.subAsks===undefined||data.subBids===undefined){return[];} var tradingFirms=[];[data.subAsks,data.subBids].forEach(function(subs){subs.forEach(function(row){row[1].forEach(function(tf){if(tradingFirms.indexOf(tf[0])===-1){tradingFirms.push(tf[0]);}});});});return tradingFirms.sort();},getTradingFirmsList:function(data){if(data.subAsks===undefined||data.subBids===undefined){return[];} var tradingFirms=[],newEl;[data.subAsks,data.subBids].forEach(function(subs){subs.forEach(function(row){row[1].forEach(function(tf){newEl=[tf[0],tf[2]];if(JSON.stringify(tradingFirms).indexOf(JSON.stringify(newEl))===-1){tradingFirms.push(newEl);}});});});tradingFirms.sort(function(a,b){return a[0]>b[0]?1:-1;});return tradingFirms;},getTradingFirmSideData:function(tradingFirmId,side,fullData){var subs=fullData.subAsks;var data=fullData.asks;if(side==='bid'){subs=fullData.subBids;data=fullData.bids;} var shares,price;subs.forEach(function(subData,idx){subData[1].forEach(function(tf){if(tf[0]===tradingFirmId){shares=tf[1];price=subData[0];}});});if(shares&&price){return[shares,price];} return null;},getTradingFirmAskAndBid:function(tradingFirmId,data){var res={};var ask=this.getTradingFirmSideData(tradingFirmId,'ask',data);var bid=this.getTradingFirmSideData(tradingFirmId,'bid',data);if(ask){res.ask=ask;} if(bid){res.bid=bid;} return res;},spawn:function(path,height,width){var height=(Ext.isDefined(height))?height:575,width=(Ext.isDefined(width))?width:425,src=Ext.String.format('{0}{1}/',path,this.symbol);bats.openWin({src:src,height:height,width:width});}});
 bats.bookCfg={supportedMarkets:['bzx','byx','edgx','edga']};